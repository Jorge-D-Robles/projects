<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Music Lesson Scheduler</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Inter", sans-serif;
            }
            .custom-loader {
                width: 50px;
                height: 50px;
                border-radius: 50%;
                background: radial-gradient(farthest-side, #766df4 94%, #0000)
                        top/8px 8px no-repeat,
                    conic-gradient(#0000 30%, #766df4);
                -webkit-mask: radial-gradient(
                    farthest-side,
                    #0000 calc(100% - 8px),
                    #000 0
                );
                animation: s3 1s infinite linear;
            }
            @keyframes s3 {
                100% {
                    transform: rotate(1turn);
                }
            }
            .table-container {
                max-height: 60vh;
                overflow-y: auto;
            }
        </style>
    </head>
    <body class="bg-gray-100 text-gray-800">
        <div class="container mx-auto p-4 md:p-8 max-w-7xl">
            <header class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">
                    Music Lesson Scheduler
                </h1>
                <p class="text-gray-600 mt-2">
                    Updated for the 25/26 School Year
                </p>
            </header>

            <main class="bg-white p-6 rounded-lg shadow-lg">
                <div id="form-container">
                    <h2 class="text-2xl font-semibold mb-6">
                        Schedule Parameters
                    </h2>
                    <form
                        id="schedule-form"
                        class="grid grid-cols-1 md:grid-cols-3 gap-6"
                    >
                        <div>
                            <label
                                for="start-date"
                                class="block text-sm font-medium text-gray-700"
                                >Start Date</label
                            >
                            <input
                                type="date"
                                id="start-date"
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2"
                            />
                        </div>
                        <div>
                            <label
                                for="day-cycle"
                                class="block text-sm font-medium text-gray-700"
                                >Starting Day Cycle (1 or 2)</label
                            >
                            <input
                                type="number"
                                id="day-cycle"
                                min="1"
                                max="2"
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2"
                            />
                        </div>
                        <div>
                            <label
                                for="weeks"
                                class="block text-sm font-medium text-gray-700"
                                >Number of Weeks (1-52)</label
                            >
                            <input
                                type="number"
                                id="weeks"
                                min="1"
                                max="52"
                                required
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2"
                            />
                        </div>
                        <div class="md:col-span-3">
                            <label
                                for="days-off"
                                class="block text-sm font-medium text-gray-700"
                                >Days Off</label
                            >
                            <div id="days-off-container" class="space-y-2 mt-1">
                                <div class="flex items-center space-x-2">
                                    <input
                                        type="date"
                                        class="day-off-input block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2"
                                    />
                                    <button
                                        type="button"
                                        id="add-day-off"
                                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-3 rounded-lg transition duration-300"
                                    >
                                        +
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="md:col-span-3 flex justify-end space-x-4">
                            <button
                                type="submit"
                                id="generate-btn"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300"
                            >
                                Generate Schedule
                            </button>
                        </div>
                    </form>
                </div>

                <div
                    id="loading-indicator"
                    class="hidden flex justify-center items-center my-8"
                >
                    <div class="custom-loader"></div>
                </div>

                <div id="schedule-output" class="hidden mt-8">
                    <h2 class="text-2xl font-semibold mb-4">
                        Generated Schedule
                    </h2>
                    <div
                        class="table-container border border-gray-200 rounded-lg"
                    >
                        <table
                            id="schedule-table"
                            class="min-w-full divide-y divide-gray-200"
                        >
                            <thead class="bg-gray-50 sticky top-0">
                                <tr>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Date
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Period
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Group
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Period
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Group
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Period
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Group
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Period
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Group
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Period
                                    </th>
                                    <th
                                        scope="col"
                                        class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                    >
                                        Group
                                    </th>
                                </tr>
                            </thead>
                            <tbody
                                class="bg-white divide-y divide-gray-200"
                            ></tbody>
                        </table>
                    </div>
                    <div class="mt-6 flex justify-end space-x-4">
                        <button
                            id="reroll-btn"
                            class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300"
                        >
                            Re-Roll
                        </button>
                        <button
                            id="save-csv-btn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300"
                        >
                            Save to CSV
                        </button>
                    </div>
                </div>
            </main>
            <footer class="text-center mt-8 text-sm text-gray-500">
                <p>
                    Original Java App by Jorge Robles. Ported to Web and Updated
                    by Gemini.
                </p>
            </footer>
        </div>

        <script>
            // --- Core Scheduling Logic ---

            /**
             * Represents a single day in the schedule.
             */
            class ScheduleEntry {
                constructor(date) {
                    this.date = date
                    this.lessons = [] // An array of {period, group} objects
                }

                addLesson(period, group) {
                    this.lessons.push({ period: `Pd ${period}`, group })
                }
            }

            /**
             * The main class for building the schedule based on new 25/26 rules.
             */
            class ScheduleBuilder {
                constructor(startDate, dayCycle, daysOff, weeks) {
                    const startParts = startDate.split("-")
                    this.startDate = new Date(
                        startParts[0],
                        startParts[1] - 1,
                        startParts[2]
                    )
                    this.dayCycle = dayCycle
                    this.daysOff = daysOff
                        .map((d) => {
                            if (!d) return null
                            const parts = d.split("-")
                            return new Date(
                                parts[0],
                                parts[1] - 1,
                                parts[2]
                            ).toDateString()
                        })
                        .filter(Boolean)
                    this.weeks = weeks
                    this.schedule = []

                    this.LESSON_GROUPS = Array.from({ length: 22 }, (_, i) =>
                        String.fromCharCode("A".charCodeAt(0) + i)
                    ) // Groups A-V
                    this.DAY1_PERIODS = [1, 4, 7, 8]
                    this.DAY2_PERIODS = [1, 2, 3, 7, 8]

                    this.periodAssignments = {}
                    this.LESSON_GROUPS.forEach(
                        (g) => (this.periodAssignments[g] = {})
                    )

                    this.groupSets = []
                    const allGroupsCopy = [...this.LESSON_GROUPS]
                    this.groupSets.push(allGroupsCopy.splice(0, 5)) // A-E
                    this.groupSets.push(allGroupsCopy.splice(0, 5)) // F-J
                    this.groupSets.push(allGroupsCopy.splice(0, 4)) // K-N
                    this.groupSets.push(allGroupsCopy.splice(0, 4)) // O-R
                    this.groupSets.push(allGroupsCopy.splice(0, 4)) // S-V
                }

                /**
                 * Rotates the bundles and the groups within them for the next cycle.
                 */
                setupNextGroupCycle() {
                    this.groupSets.push(this.groupSets.shift())
                    this.groupSets.forEach((set) => {
                        if (set.length > 1) {
                            set.push(set.shift())
                        }
                    })
                    return this.groupSets.flat()
                }

                /**
                 * Finds the best available group for a period.
                 * @param {string[]} groupsForCycle - The list of groups remaining in the cycle.
                 * @param {Date} date - The current date for scheduling.
                 * @param {number} period - The period to schedule for.
                 * @param {boolean} isMercySearch - If true, relaxes the 28-day rule and finds the "least bad" option.
                 * @returns {object} { group: string, indexInCycle: number }
                 */
                findBestGroupForPeriod(
                    groupsForCycle,
                    date,
                    period,
                    isMercySearch
                ) {
                    let mercyCandidate = {
                        group: "MU",
                        indexInCycle: -1,
                        longestDaysSince: -1,
                    }

                    for (let i = 0; i < groupsForCycle.length; i++) {
                        const potentialGroup = groupsForCycle[i]
                        const lastAssignmentDate =
                            this.periodAssignments[potentialGroup][period]

                        const daysSince = lastAssignmentDate
                            ? (date - lastAssignmentDate) /
                              (1000 * 60 * 60 * 24)
                            : Infinity

                        if (!isMercySearch) {
                            // Standard search: return the first group that satisfies the 28-day rule.
                            if (daysSince >= 28) {
                                return {
                                    group: potentialGroup,
                                    indexInCycle: i,
                                }
                            }
                        } else {
                            // Mercy search: find the group that has waited the longest, regardless of the 28-day rule.
                            if (daysSince > mercyCandidate.longestDaysSince) {
                                mercyCandidate = {
                                    group: potentialGroup,
                                    indexInCycle: i,
                                    longestDaysSince: daysSince,
                                }
                            }
                        }
                    }

                    // If standard search, we fell through, so no eligible group was found.
                    if (!isMercySearch) return { group: "MU", indexInCycle: -1 }

                    // If mercy search, return the best candidate we found.
                    return mercyCandidate
                }

                /**
                 * Generates the entire schedule.
                 */
                buildSchedule() {
                    let currentDate = new Date(this.startDate.getTime())
                    let endDate = new Date(this.startDate.getTime())
                    endDate.setDate(endDate.getDate() + this.weeks * 7)

                    let groupsForCycle = this.groupSets.flat()
                    let weeklyLessonCount = 0

                    while (currentDate < endDate) {
                        const dayOfWeek = currentDate.getDay()

                        if (dayOfWeek === 1) {
                            // Monday
                            weeklyLessonCount = 0
                        }

                        const isWeekday = dayOfWeek > 0 && dayOfWeek < 6
                        const isDayOff = this.daysOff.includes(
                            currentDate.toDateString()
                        )

                        if (isWeekday && !isDayOff) {
                            const entry = new ScheduleEntry(
                                new Date(currentDate.getTime())
                            )
                            const periodsForDay =
                                this.dayCycle % 2 !== 0
                                    ? this.DAY1_PERIODS
                                    : this.DAY2_PERIODS

                            for (const period of periodsForDay) {
                                if (weeklyLessonCount >= 22) {
                                    entry.addLesson(period, "MU")
                                } else {
                                    if (groupsForCycle.length === 0) {
                                        groupsForCycle =
                                            this.setupNextGroupCycle()
                                    }

                                    // --- NEW, ROBUST LOGIC ---

                                    // 1. First attempt: Strict search on the rotating group cycle.
                                    let assignment =
                                        this.findBestGroupForPeriod(
                                            groupsForCycle,
                                            currentDate,
                                            period,
                                            false // Strict search
                                        )

                                    // 2. Second attempt: If the first failed, search ALL groups strictly.
                                    if (assignment.group === "MU") {
                                        const usedGroupsToday =
                                            entry.lessons.map((l) => l.group)
                                        const allAvailableGroups =
                                            this.LESSON_GROUPS.filter(
                                                (g) =>
                                                    !usedGroupsToday.includes(g)
                                            )

                                        assignment =
                                            this.findBestGroupForPeriod(
                                                allAvailableGroups,
                                                currentDate,
                                                period,
                                                false // Still a strict search
                                            )
                                    }

                                    // 3. Final Fallback: If BOTH strict searches failed, now we use mercy.
                                    if (assignment.group === "MU") {
                                        assignment =
                                            this.findBestGroupForPeriod(
                                                groupsForCycle,
                                                currentDate,
                                                period,
                                                true // Mercy search
                                            )
                                    }

                                    // --- END OF NEW LOGIC ---

                                    if (assignment.group !== "MU") {
                                        entry.addLesson(
                                            period,
                                            assignment.group
                                        )
                                        this.periodAssignments[
                                            assignment.group
                                        ][period] = new Date(
                                            currentDate.getTime()
                                        )

                                        // Remove the assigned group from the current cycle if it exists there.
                                        const indexInCycle =
                                            groupsForCycle.indexOf(
                                                assignment.group
                                            )
                                        if (indexInCycle > -1) {
                                            groupsForCycle.splice(
                                                indexInCycle,
                                                1
                                            )
                                        }
                                    } else {
                                        entry.addLesson(period, "MU")
                                    }
                                }
                                weeklyLessonCount++
                            }
                            this.schedule.push(entry)
                            this.dayCycle++
                        }
                        currentDate.setDate(currentDate.getDate() + 1)
                    }
                    return this.schedule
                }
            }
            // --- UI Logic and Event Handling ---

            let lastScheduleParams = {}

            document.addEventListener("DOMContentLoaded", () => {
                const form = document.getElementById("schedule-form")
                const generateBtn = document.getElementById("generate-btn")
                const rerollBtn = document.getElementById("reroll-btn")
                const saveCsvBtn = document.getElementById("save-csv-btn")
                const addDayOffBtn = document.getElementById("add-day-off")

                const today = new Date()
                const yyyy = today.getFullYear()
                const mm = String(today.getMonth() + 1).padStart(2, "0")
                const dd = String(today.getDate()).padStart(2, "0")
                document.getElementById(
                    "start-date"
                ).value = `${yyyy}-${mm}-${dd}`

                addDayOffBtn.addEventListener("click", () => {
                    const container =
                        document.getElementById("days-off-container")
                    const newDayOff = document.createElement("div")
                    newDayOff.className = "flex items-center space-x-2 mt-2"
                    newDayOff.innerHTML = `
                    <input type="date" class="day-off-input block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                    <button type="button" class="remove-day-off bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-3 rounded-lg transition duration-300">-</button>
                `
                    container.appendChild(newDayOff)
                })

                document
                    .getElementById("days-off-container")
                    .addEventListener("click", (e) => {
                        if (e.target.classList.contains("remove-day-off")) {
                            e.target.parentElement.remove()
                        }
                    })

                form.addEventListener("submit", (e) => {
                    e.preventDefault()
                    runScheduler()
                })

                rerollBtn.addEventListener("click", () => {
                    if (lastScheduleParams.startDate) {
                        const { startDate, dayCycle, daysOff, weeks } =
                            lastScheduleParams
                        const scheduleBuilder = new ScheduleBuilder(
                            startDate,
                            dayCycle,
                            daysOff,
                            weeks
                        )
                        const schedule = scheduleBuilder.buildSchedule()
                        displaySchedule(schedule)
                    }
                })

                saveCsvBtn.addEventListener("click", () => {
                    exportTableToCSV("musical-lesson-schedule.csv")
                })

                function runScheduler() {
                    document
                        .getElementById("loading-indicator")
                        .classList.remove("hidden")
                    document
                        .getElementById("schedule-output")
                        .classList.add("hidden")
                    generateBtn.disabled = true

                    setTimeout(() => {
                        try {
                            const params = getScheduleParameters()
                            if (!params) return
                            lastScheduleParams = params

                            const { startDate, dayCycle, daysOff, weeks } =
                                params
                            const scheduleBuilder = new ScheduleBuilder(
                                startDate,
                                dayCycle,
                                daysOff,
                                weeks
                            )
                            const schedule = scheduleBuilder.buildSchedule()
                            displaySchedule(schedule)
                        } catch (error) {
                            console.error("Error generating schedule:", error)
                            alert(
                                "An error occurred. Please check your inputs and try again."
                            )
                        } finally {
                            document
                                .getElementById("loading-indicator")
                                .classList.add("hidden")
                            document
                                .getElementById("schedule-output")
                                .classList.remove("hidden")
                            generateBtn.disabled = false
                        }
                    }, 250)
                }

                function getScheduleParameters() {
                    const startDate =
                        document.getElementById("start-date").value
                    const dayCycle = parseInt(
                        document.getElementById("day-cycle").value,
                        10
                    )
                    const weeks = parseInt(
                        document.getElementById("weeks").value,
                        10
                    )

                    const daysOffInputs =
                        document.querySelectorAll(".day-off-input")
                    const daysOff = Array.from(daysOffInputs)
                        .map((input) => input.value)
                        .filter(Boolean)

                    if (!startDate || isNaN(dayCycle) || isNaN(weeks)) {
                        alert(
                            "Please fill in all required fields: Start Date, Day Cycle, and Weeks."
                        )
                        return null
                    }
                    if (dayCycle < 1 || dayCycle > 2) {
                        alert("Starting Day Cycle must be 1 or 2.")
                        return null
                    }
                    if (weeks < 1 || weeks > 52) {
                        alert("Number of weeks must be between 1 and 52.")
                        return null
                    }

                    return { startDate, dayCycle, daysOff, weeks }
                }

                function displaySchedule(schedule) {
                    const tableBody = document.querySelector(
                        "#schedule-table tbody"
                    )
                    tableBody.innerHTML = ""

                    if (schedule.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="11" class="text-center py-4">No schedule generated for the selected dates. Check days off.</td></tr>`
                        return
                    }

                    schedule.forEach((entry, index) => {
                        if (entry.date.getDay() === 1 && index > 0) {
                            const spacerRow = document.createElement("tr")
                            spacerRow.className = "bg-gray-200"
                            spacerRow.innerHTML = `<td colspan="11" class="py-1"></td>`
                            tableBody.appendChild(spacerRow)
                        }

                        const row = document.createElement("tr")
                        const formattedDate = entry.date.toLocaleDateString(
                            undefined,
                            {
                                weekday: "short",
                                year: "numeric",
                                month: "short",
                                day: "numeric",
                            }
                        )

                        let rowHTML = `<td class="px-2 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${formattedDate}</td>`

                        for (let i = 0; i < 5; i++) {
                            if (entry.lessons[i]) {
                                const groupClass = entry.lessons[
                                    i
                                ].group.startsWith("MU")
                                    ? "text-red-600"
                                    : "text-gray-800"
                                rowHTML += `
                                    <td class="px-2 py-3 whitespace-nowrap text-sm text-gray-500">${entry.lessons[i].period}</td>
                                    <td class="px-2 py-3 whitespace-nowrap text-sm ${groupClass} font-semibold">${entry.lessons[i].group}</td>
                                `
                            } else {
                                rowHTML +=
                                    '<td class="px-2 py-3"></td><td class="px-2 py-3"></td>'
                            }
                        }

                        row.innerHTML = rowHTML
                        tableBody.appendChild(row)
                    })
                }

                function exportTableToCSV(filename) {
                    const csv = []
                    const rows = document.querySelectorAll("#schedule-table tr")

                    const header = []
                    document
                        .querySelectorAll("#schedule-table th")
                        .forEach((th) => header.push(`"${th.innerText}"`))
                    csv.push(header.join(","))

                    rows.forEach((row) => {
                        if (row.querySelector('td[colspan="11"]')) {
                            return
                        }
                        const cols = row.querySelectorAll("td")
                        const rowData = []
                        cols.forEach((col) => {
                            rowData.push(
                                '"' + col.innerText.replace(/"/g, '""') + '"'
                            )
                        })
                        csv.push(rowData.join(","))
                    })

                    downloadCSV(csv.join("\n"), filename)
                }

                function downloadCSV(csv, filename) {
                    const csvFile = new Blob([csv], { type: "text/csv" })
                    const downloadLink = document.createElement("a")
                    downloadLink.download = filename
                    downloadLink.href = window.URL.createObjectURL(csvFile)
                    downloadLink.style.display = "none"
                    document.body.appendChild(downloadLink)
                    downloadLink.click()
                    document.body.removeChild(downloadLink)
                }
            })
        </script>
    </body>
</html>
